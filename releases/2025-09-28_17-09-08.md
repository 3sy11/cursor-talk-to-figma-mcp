# Feature Enhancement #005: 文本节点布局大小设置工具实现

**Date**: September 28, 2025  
**Time**: 17:09 CST  
**Type**: Major Feature Enhancement  
**Status**: ✅ Completed

### Feature Description

基于用户对文本节点布局控制的需求，特别是Auto Height + Fill Width组合功能的需求，实现了专门的文本节点布局大小设置MCP工具 `text_layout_sizing`。该工具提供了对TEXT节点布局属性的精确控制，支持textAutoResize、layoutSizingHorizontal、layoutSizingVertical三个核心属性。

### 触发需求

用户询问当text layout设置为auto height之后，宽度如何设置为fill的问题。经过研究发现，Figma界面中确实支持这种组合设置，但需要TEXT节点在auto-layout父容器中才能实现。

### 需求分析

#### 现有工具的局限性
- `set_layout_sizing`: 通用工具，但错误地拒绝了TEXT类型节点
- `resize_node`: 只能设置固定尺寸，不支持自动调整
- 缺乏专门针对TEXT节点的布局控制工具

#### 设计目标
- **专门化**: 专门处理TEXT节点的布局属性
- **完整支持**: 支持textAutoResize和layoutSizing的所有组合
- **条件验证**: 智能检查FILL模式的使用条件
- **错误处理**: 详细的验证和错误信息

### Solution Implementation

#### 新增工具: `text_layout_sizing`

**功能**: 专门的TEXT节点布局大小设置工具

**参数结构**:
```typescript
{
  nodeId: string,                                    // TEXT节点ID
  textAutoResize?: TextAutoResize,                   // 文本自动调整行为
  layoutSizingHorizontal?: LayoutSizingHorizontal,   // 水平布局大小
  layoutSizingVertical?: LayoutSizingVertical        // 垂直布局大小
}
```

**支持的属性枚举**:
```typescript
type TextAutoResize = 
  | "WIDTH_AND_HEIGHT"  // 宽度和高度都根据内容自动调整
  | "HEIGHT"            // 只有高度根据内容自动调整，宽度固定
  | "NONE"              // 固定大小，不自动调整

type LayoutSizingHorizontal = 
  | "FIXED"             // 固定宽度
  | "HUG"               // 根据内容调整宽度
  | "FILL"              // 填充父容器宽度（需要auto-layout父容器）

type LayoutSizingVertical = 
  | "FIXED"             // 固定高度
  | "HUG"               // 根据内容调整高度
  | "FILL"              // 填充父容器高度（需要auto-layout父容器）
```

### Technical Implementation

#### Fix 1: 服务器端实现

**文件**: `src/talk_to_figma_mcp/server.ts`

添加了新的MCP工具定义：

```typescript
// 文本节点布局大小设置工具
server.tool("text_layout_sizing", {
  nodeId: z.string(),
  textAutoResize: z.enum(["WIDTH_AND_HEIGHT", "HEIGHT", "NONE"]).optional(),
  layoutSizingHorizontal: z.enum(["FIXED", "HUG", "FILL"]).optional(),
  layoutSizingVertical: z.enum(["FIXED", "HUG", "FILL"]).optional()
});
```

#### Fix 2: 插件端实现

**文件**: `src/cursor_mcp_plugin/code.js`

实现了对应的处理函数：

```javascript
// 文本节点布局大小设置函数
async function setTextLayoutSizing(params) {
  // 节点类型验证（只支持TEXT）
  // textAutoResize属性设置
  // layoutSizingHorizontal属性设置（包含FILL条件检查）
  // layoutSizingVertical属性设置（包含FILL条件检查）
  // 使用官方API: node.textAutoResize, node.layoutSizingHorizontal, node.layoutSizingVertical
}
```

#### Fix 3: 智能条件验证

实现了FILL模式的条件检查：

```javascript
// 检查FILL模式的条件
if (layoutSizingHorizontal === "FILL") {
  if (!node.parent || node.parent.layoutMode === "NONE") {
    throw new Error("FILL sizing is only valid when TEXT node is inside an auto-layout parent container");
  }
}
```

#### Fix 4: 类型系统更新

更新了`FigmaCommand`和`CommandParams`类型定义：

```typescript
type FigmaCommand = 
  | "text_layout_sizing"
  | // ... 其他命令

type CommandParams = {
  text_layout_sizing: {
    nodeId: string;
    textAutoResize?: "WIDTH_AND_HEIGHT" | "HEIGHT" | "NONE";
    layoutSizingHorizontal?: "FIXED" | "HUG" | "FILL";
    layoutSizingVertical?: "FIXED" | "HUG" | "FILL";
  };
  // ... 其他参数类型
};
```

### Key Features

#### 1. 完整布局控制
- ✅ **textAutoResize支持**: 支持WIDTH_AND_HEIGHT、HEIGHT、NONE三种模式
- ✅ **layoutSizing支持**: 支持FIXED、HUG、FILL三种模式
- ✅ **组合支持**: 支持textAutoResize和layoutSizing的任意组合

#### 2. 智能条件验证
- ✅ **节点类型检查**: 确保只有TEXT类型节点可以使用
- ✅ **FILL条件检查**: 自动检查FILL模式是否需要auto-layout父容器
- ✅ **参数有效性验证**: 确保所有参数值在允许范围内

#### 3. 详细错误处理
- ✅ **具体错误信息**: 提供详细的错误原因和修复建议
- ✅ **条件说明**: 明确说明FILL模式的使用条件
- ✅ **使用指导**: 提供获取节点ID的方法建议

### Usage Examples

#### Auto Height + Fill Width (核心功能)
```json
{
  "nodeId": "123:456",
  "textAutoResize": "HEIGHT",
  "layoutSizingHorizontal": "FILL"
}
```

#### 自动宽度和高度
```json
{
  "nodeId": "123:456",
  "textAutoResize": "WIDTH_AND_HEIGHT"
}
```

#### 在auto-layout中拥抱内容
```json
{
  "nodeId": "123:456",
  "layoutSizingHorizontal": "HUG",
  "layoutSizingVertical": "HUG"
}
```

#### 完全填充容器
```json
{
  "nodeId": "123:456",
  "layoutSizingHorizontal": "FILL",
  "layoutSizingVertical": "FILL"
}
```

#### 固定尺寸文本
```json
{
  "nodeId": "123:456",
  "textAutoResize": "NONE"
}
```

### 工具分工体系

建立了清晰的工具分工体系：

| 用途 | 工具 | 说明 |
|------|------|------|
| TEXT节点布局 | `text_layout_sizing` | 专门处理TEXT节点布局属性 |
| 通用布局 | `set_layout_sizing` | 处理FRAME/COMPONENT等 |
| 节点调整 | `resize_node` | 设置固定尺寸 |
| 文本内容 | `set_text_content` | 修改文本内容 |

### 布局属性组合矩阵

| textAutoResize | layoutSizingHorizontal | layoutSizingVertical | 效果 |
|---------------|------------------------|---------------------|------|
| HEIGHT | FILL | HUG | 高度自动调整，宽度填充容器 |
| HEIGHT | FIXED | HUG | 高度自动调整，宽度固定 |
| WIDTH_AND_HEIGHT | HUG | HUG | 宽度和高度都根据内容调整 |
| NONE | FILL | FILL | 固定尺寸，但在容器中填充 |
| HEIGHT | HUG | FILL | 高度自动调整，宽度根据内容，垂直填充 |

### Files Modified

- `src/talk_to_figma_mcp/server.ts` - 添加text_layout_sizing MCP工具和类型定义
- `src/cursor_mcp_plugin/code.js` - 实现setTextLayoutSizing函数

### Testing & Validation

- ✅ TEXT节点布局设置成功
- ✅ Auto Height + Fill Width组合正常工作
- ✅ FILL模式条件验证正常工作
- ✅ 错误处理提供清晰反馈
- ✅ 与现有工具无冲突
- ✅ 所有布局属性组合测试通过

### Impact

这次功能增强提供了完整的TEXT节点布局控制能力：

- 🎯 **解决核心需求**: 成功实现Auto Height + Fill Width组合
- 🛡️ **提供类型安全**: 严格的节点类型和条件验证
- 🚀 **提升用户体验**: 专门的工具名称和参数结构，使用更直观
- 📚 **符合最佳实践**: 基于Figma官方API的标准实现
- 🔧 **保持架构一致**: 与现有工具体系完美集成
- 💡 **智能验证**: 自动检查使用条件，避免常见错误

现在用户可以精确控制TEXT节点的所有布局属性，实现现代UI设计中的各种文本布局需求，特别是响应式文本设计中的Auto Height + Fill Width组合。

### 重要说明

**FILL模式使用条件**: 
- TEXT节点必须在auto-layout父容器中
- 父容器必须启用auto-layout (layoutMode !== "NONE")
- 使用前建议先使用 `get_selection` 或 `get_node_info` 获取节点ID

**推荐工作流**:
1. 将TEXT节点放入auto-layout框架中
2. 使用 `text_layout_sizing` 设置布局属性
3. 根据需要调整父容器的auto-layout设置
