# Feature Enhancement #005: 元素层级关系调整功能实现

## 📅 更新日期
2025-09-23

## 🎯 功能概述
实现了完整的元素层级关系调整功能，支持6种层级操作，让用户能够精确控制Figma中元素的层级顺序和父子关系。

## 🛠️ 新增MCP工具

### 1. `bring_to_front`
- **功能**: 将节点置顶（移到层级栈的最前面）
- **参数**: `nodeId` - 要置顶的节点ID
- **实现**: 使用`parent.appendChild(node)`将节点移到父容器的最后位置

### 2. `send_to_back`
- **功能**: 将节点置底（移到层级栈的最后面）
- **参数**: `nodeId` - 要置底的节点ID
- **实现**: 使用`parent.insertChild(0, node)`将节点插入到父容器的第一个位置

### 3. `bring_forward`
- **功能**: 将节点上移一层
- **参数**: `nodeId` - 要上移的节点ID
- **实现**: 计算当前索引，如果已是最后则置顶，否则插入到下一个位置

### 4. `send_backward`
- **功能**: 将节点下移一层
- **参数**: `nodeId` - 要下移的节点ID
- **实现**: 计算当前索引，如果已是第一个则置底，否则插入到上一个位置

### 5. `change_parent`
- **功能**: 改变节点的父容器
- **参数**: 
  - `nodeId` - 要移动的节点ID
  - `newParentId` - 新父容器的ID
- **实现**: 验证新父容器支持子节点，然后使用`newParent.appendChild(node)`

### 6. `insert_at_index`
- **功能**: 将节点插入到指定索引位置
- **参数**: 
  - `nodeId` - 要移动的节点ID
  - `index` - 目标索引位置（0-based）
- **实现**: 验证索引范围，使用`parent.insertChild(index, node)`

## 🔧 技术实现

### Server端更新 (`server.ts`)
- 添加了6个新的MCP工具定义
- 更新了`FigmaCommand`类型定义
- 更新了`CommandParams`接口定义
- 每个工具都有完整的错误处理和参数验证

### Plugin端更新 (`code.js`)
- 实现了6个层级调整函数
- 所有函数都包含完整的错误处理
- 使用`figma.loadAllPagesAsync()`确保跨页面操作
- 详细的参数验证和边界检查
- 更新了`handleCommand`函数添加新的命令处理

## 🎨 功能特点

### 智能层级操作
- **置顶/置底**: 直接移到层级栈的极端位置
- **单层移动**: 精确控制层级顺序的微调
- **父容器变更**: 支持跨容器移动节点
- **精确位置**: 支持按索引位置插入

### 完善的错误处理
- 节点存在性验证
- 父节点支持性检查
- 索引范围验证
- 详细的错误信息反馈

### 跨页面支持
- 所有操作都支持跨页面节点
- 自动加载所有页面确保操作成功

## 📊 使用场景

1. **设计整理**: 调整元素显示顺序，确保重要元素在最前面
2. **组件管理**: 重新组织组件层级结构
3. **布局调整**: 精确控制元素的层级关系
4. **批量操作**: 结合其他工具实现复杂的层级管理

## 🔍 技术细节

### 层级操作原理
- Figma中的层级顺序由父节点的`children`数组决定
- 数组索引越大，层级越高（越靠前显示）
- `appendChild()`将节点添加到数组末尾（最前面）
- `insertChild(index, node)`在指定位置插入节点

### 边界处理
- 置顶时如果已在最前面，保持位置不变
- 置底时如果已在最后面，保持位置不变
- 单层移动时处理边界情况（最前/最后位置）
- 索引超出范围时提供详细错误信息

## 🎉 功能优势

1. **完整性**: 覆盖了所有常见的层级操作需求
2. **精确性**: 支持精确的索引位置控制
3. **安全性**: 完善的参数验证和错误处理
4. **灵活性**: 支持跨页面和跨容器的层级操作
5. **易用性**: 直观的API设计和清晰的错误信息

## 📝 更新文件
- `src/talk_to_figma_mcp/server.ts` - 添加6个MCP工具定义
- `src/cursor_mcp_plugin/code.js` - 实现6个层级调整函数

## 🚀 后续计划
- 考虑添加批量层级操作功能
- 支持层级操作的撤销/重做
- 添加层级关系可视化工具
