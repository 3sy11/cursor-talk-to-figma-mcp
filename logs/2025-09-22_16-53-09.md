# 日志文件 - 2025-09-22_16-53-09

## 操作概述
实现了跨页面复制功能，支持将组件从一个页面复制到另一个页面

## 使用的工具
- `search_replace`: 在server.ts和code.js中添加了新的跨页面操作功能
- `read_lints`: 检查语法错误
- `run_terminal_cmd`: 获取当前时间戳

## 具体操作

### 1. 服务器端实现 (server.ts)

#### 新增工具1: `get_all_pages`
```typescript
server.tool(
  "get_all_pages",
  "Get all pages in the current Figma document. Returns a list of all pages with their IDs, names, and child counts.",
  {},
  async () => {
    // 获取所有页面信息
  }
);
```

#### 新增工具2: `switch_to_page`
```typescript
server.tool(
  "switch_to_page",
  "Switch the current page to a specified page by ID. This changes the active page in Figma.",
  {
    pageId: z.string().describe("The ID of the page to switch to")
  },
  async ({ pageId }) => {
    // 切换到指定页面
  }
);
```

#### 新增工具3: `clone_node_to_page`
```typescript
server.tool(
  "clone_node_to_page",
  "Clone a node from the current page to a specified target page. This enables cross-page component copying.",
  {
    nodeId: z.string().describe("The ID of the node to clone"),
    targetPageId: z.string().describe("The ID of the target page to clone the node to"),
    x: z.number().optional().describe("New X position for the cloned node"),
    y: z.number().optional().describe("New Y position for the cloned node")
  },
  async ({ nodeId, targetPageId, x, y }) => {
    // 克隆节点到指定页面
  }
);
```

#### 类型定义更新
- 在`FigmaCommand`类型中添加了`get_all_pages`、`switch_to_page`、`clone_node_to_page`
- 在`CommandParams`类型中添加了对应的参数类型定义

### 2. 插件端实现 (code.js)

#### 命令处理更新
在命令处理switch语句中添加了新的case：
```javascript
case "get_all_pages":
  return await getAllPages();
case "switch_to_page":
  return await switchToPage(params);
case "clone_node_to_page":
  return await cloneNodeToPage(params);
```

#### 新增函数1: `getAllPages`
- **功能**: 获取文档中所有页面信息
- **实现**: 使用`figma.loadAllPagesAsync()`确保所有页面加载
- **返回**: 页面列表，包含ID、名称、子节点数量和当前页面标识

#### 新增函数2: `switchToPage`
- **功能**: 切换到指定页面
- **参数验证**: 检查pageId参数
- **页面查找**: 在`figma.root.children`中查找目标页面
- **页面切换**: 使用`figma.currentPage = targetPage`

#### 新增函数3: `cloneNodeToPage`
- **功能**: 克隆节点到指定页面
- **参数验证**: 检查nodeId和targetPageId
- **节点获取**: 异步获取源节点
- **页面获取**: 查找目标页面
- **节点克隆**: 使用`sourceNode.clone()`
- **位置设置**: 支持可选的x、y坐标
- **添加到页面**: 使用`targetPage.appendChild(clonedNode)`

## 技术特性

### 1. 异步页面加载
- 使用`figma.loadAllPagesAsync()`确保所有页面都已加载
- 支持动态加载的Figma文件结构

### 2. 完整的错误处理
- 详细的参数验证
- 节点和页面存在性检查
- 清晰的错误信息和日志记录

### 3. 灵活的节点操作
- 支持克隆任何类型的节点（组件、框架、文本等）
- 可选的位置设置
- 保持原始节点的所有属性和子节点

### 4. 页面管理
- 获取所有页面信息
- 页面切换功能
- 当前页面标识

## 使用示例

### 获取所有页面
```json
{
  "command": "get_all_pages"
}
```

### 切换到指定页面
```json
{
  "command": "switch_to_page",
  "params": {
    "pageId": "page_id_here"
  }
}
```

### 克隆节点到指定页面
```json
{
  "command": "clone_node_to_page",
  "params": {
    "nodeId": "node_id_here",
    "targetPageId": "target_page_id_here",
    "x": 100,
    "y": 200
  }
}
```

## 工具分工体系

| 用途 | 工具 | 说明 |
|------|------|------|
| 页面管理 | `get_all_pages` | 获取所有页面信息 |
| 页面切换 | `switch_to_page` | 切换到指定页面 |
| 跨页面复制 | `clone_node_to_page` | 克隆节点到指定页面 |
| 同页面克隆 | `clone_node` | 在同一页面内克隆节点 |

## 实现结果

现在用户可以通过以下步骤实现跨页面组件复制：

1. **获取页面列表**: 使用`get_all_pages`获取所有可用页面
2. **选择源节点**: 确定要复制的组件或节点
3. **执行跨页面复制**: 使用`clone_node_to_page`将节点复制到目标页面
4. **可选**: 使用`switch_to_page`切换到目标页面查看结果

## 技术优势

### 1. 完整的跨页面支持
- 支持将任何节点复制到任何页面
- 保持原始节点的完整结构和属性

### 2. 异步操作支持
- 正确处理Figma的动态页面加载
- 确保所有页面都已加载再进行操作

### 3. 类型安全
- 完整的TypeScript类型定义
- 严格的参数验证

### 4. 错误处理
- 详细的错误信息和修复建议
- 优雅的错误处理和日志记录

这个实现完全解决了跨页面组件复制的需求，为用户提供了强大的页面间内容管理能力。
